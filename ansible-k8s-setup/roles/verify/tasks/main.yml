---
# ============================================
# Verify Role - Main Tasks
# Purpose: Verify all prerequisites are met
# ============================================

- name: Wait for system to be ready
  wait_for_connection:
    timeout: 300
    delay: 5

- name: Gather system facts
  setup:

- name: Display node information
  debug:
    msg: |
      Node: {{ ansible_hostname }}
      IP: {{ ansible_default_ipv4.address }}
      Role: {{ k8s_role }}
      OS: {{ ansible_distribution }} {{ ansible_distribution_version }}

- name: Check if node-ready marker exists
  stat:
    path: /tmp/node-ready
  register: node_ready_marker

- name: Fail if node is not ready
  fail:
    msg: "Node {{ ansible_hostname }} is not ready! User data may have failed."
  when: not node_ready_marker.stat.exists

- name: Check swap is disabled
  shell: cat /proc/swaps | wc -l
  register: swap_check
  changed_when: false

- name: Verify swap is disabled
  assert:
    that:
      - swap_check.stdout | int == 1
    fail_msg: "Swap is not disabled on {{ ansible_hostname }}"
    success_msg: "✅ Swap is disabled"

- name: Check containerd service
  systemd:
    name: containerd
  check_mode: yes
  register: containerd_status

- name: Verify containerd is running
  assert:
    that:
      - containerd_status.status.ActiveState == "active"
    fail_msg: "Containerd is not running on {{ ansible_hostname }}"
    success_msg: "✅ Containerd is running"

- name: Check kubelet service
  systemd:
    name: kubelet
  check_mode: yes
  register: kubelet_status

- name: Verify kubelet is enabled
  assert:
    that:
      - kubelet_status.status.UnitFileState == "enabled"
    fail_msg: "Kubelet is not enabled on {{ ansible_hostname }}"
    success_msg: "✅ Kubelet is enabled"

- name: Check kubeadm version
  command: kubeadm version -o short
  register: kubeadm_version
  changed_when: false

- name: Display kubeadm version
  debug:
    msg: "✅ kubeadm version: {{ kubeadm_version.stdout }}"

- name: Check kubectl version
  command: kubectl version --client -o json
  register: kubectl_version
  changed_when: false
  failed_when: false

- name: Display kubectl status
  debug:
    msg: "✅ kubectl is installed"
  when: kubectl_version.rc == 0

- name: Check kernel modules
  shell: lsmod | grep -E 'overlay|br_netfilter'
  register: kernel_modules
  changed_when: false

- name: Verify kernel modules are loaded
  assert:
    that:
      - "'overlay' in kernel_modules.stdout"
      - "'br_netfilter' in kernel_modules.stdout"
    fail_msg: "Required kernel modules not loaded on {{ ansible_hostname }}"
    success_msg: "✅ Kernel modules loaded (overlay, br_netfilter)"

- name: Check sysctl parameters
  shell: |
    sysctl net.bridge.bridge-nf-call-iptables \
           net.bridge.bridge-nf-call-ip6tables \
           net.ipv4.ip_forward
  register: sysctl_params
  changed_when: false

- name: Verify sysctl parameters
  assert:
    that:
      - "'net.bridge.bridge-nf-call-iptables = 1' in sysctl_params.stdout"
      - "'net.ipv4.ip_forward = 1' in sysctl_params.stdout"
    fail_msg: "Sysctl parameters not configured correctly"
    success_msg: "✅ Sysctl parameters configured"

- name: Check EBS volume mount (Masters)
  stat:
    path: "{{ etcd_data_dir }}"
  register: etcd_volume
  when: k8s_role == "master"

- name: Verify etcd volume is mounted (Masters)
  assert:
    that:
      - etcd_volume.stat.exists
      - etcd_volume.stat.isdir
    fail_msg: "etcd volume not mounted on {{ ansible_hostname }}"
    success_msg: "✅ etcd volume mounted at {{ etcd_data_dir }}"
  when: k8s_role == "master"

- name: Check EBS volume mount (Workers)
  stat:
    path: "{{ containerd_data_dir }}"
  register: containerd_volume
  when: k8s_role == "worker"

- name: Verify containerd volume is mounted (Workers)
  assert:
    that:
      - containerd_volume.stat.exists
      - containerd_volume.stat.isdir
    fail_msg: "containerd volume not mounted on {{ ansible_hostname }}"
    success_msg: "✅ containerd volume mounted at {{ containerd_data_dir }}"
  when: k8s_role == "worker"

- name: Test DNS resolution
  command: nslookup google.com
  register: dns_test
  changed_when: false
  failed_when: false

- name: Display DNS status
  debug:
    msg: "{{ '✅ DNS working' if dns_test.rc == 0 else '⚠️ DNS issues detected' }}"

- name: Display verification summary
  debug:
    msg: |
      ╔═══════════════════════════════════════════════════════╗
      ║  ✅ Node {{ ansible_hostname }} VERIFIED!            ║
      ╚═══════════════════════════════════════════════════════╝
      
      • Hostname: {{ ansible_hostname }}
      • IP: {{ ansible_default_ipv4.address }}
      • Role: {{ k8s_role }}
      • OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
      • Containerd: Running
      • Kubelet: Enabled
      • Swap: Disabled
      • Kernel modules: Loaded
      • Sysctl: Configured
      {% if k8s_role == 'master' %}
      • etcd volume: Mounted
      {% else %}
      • containerd volume: Mounted
      {% endif %}
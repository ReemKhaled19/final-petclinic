---
- name: Create Kubernetes Namespaces
  hosts: first_master
  gather_facts: false
  become: true
  
  vars:
    namespaces:
      - name: dev
        environment: development
      - name: test
        environment: testing
      - name: prod
        environment: production

  tasks:
    - name: Check existing namespaces
      ansible.builtin.shell: kubectl get namespaces -o jsonpath='{.items[*].metadata.name}'
      register: existing_namespaces
      changed_when: false

    - name: Display existing namespaces
      ansible.builtin.debug:
        msg: "Existing namespaces: {{ existing_namespaces.stdout }}"

    - name: Create namespaces
      ansible.builtin.shell: |
        kubectl create namespace {{ item.name }} --dry-run=client -o yaml | \
        kubectl apply -f -
      loop: "{{ namespaces }}"
      register: ns_create
      changed_when: "'created' in ns_create.stdout or 'configured' in ns_create.stdout"

    - name: Label namespaces
      ansible.builtin.shell: |
        kubectl label namespace {{ item.name }} \
          environment={{ item.environment }} \
          managed-by=ansible \
          --overwrite
      loop: "{{ namespaces }}"
      changed_when: false

    - name: Create ServiceAccount for each namespace
      ansible.builtin.shell: |
        kubectl create serviceaccount {{ item.name }}-admin \
          -n {{ item.name }} \
          --dry-run=client -o yaml | kubectl apply -f -
      loop: "{{ namespaces }}"
      changed_when: false

    - name: Create Role for namespace admin
      ansible.builtin.shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: rbac.authorization.k8s.io/v1
        kind: Role
        metadata:
          name: namespace-admin
          namespace: {{ item.name }}
        rules:
        - apiGroups: ["*"]
          resources: ["*"]
          verbs: ["*"]
        EOF
      loop: "{{ namespaces }}"
      changed_when: false

    - name: Create RoleBinding
      ansible.builtin.shell: |
        kubectl create rolebinding {{ item.name }}-admin-binding \
          --role=namespace-admin \
          --serviceaccount={{ item.name }}:{{ item.name }}-admin \
          -n {{ item.name }} \
          --dry-run=client -o yaml | kubectl apply -f -
      loop: "{{ namespaces }}"
      changed_when: false

    - name: Get all namespaces with labels
      ansible.builtin.shell: kubectl get namespaces --show-labels
      register: all_namespaces
      changed_when: false

    - name: Display all namespaces
      ansible.builtin.debug:
        msg: "{{ all_namespaces.stdout_lines }}"

    - name: Get ServiceAccounts
      ansible.builtin.shell: |
        for ns in dev test prod; do
          echo "Namespace: $ns"
          kubectl get sa -n $ns
          echo ""
        done
      register: service_accounts
      changed_when: false

    - name: Display ServiceAccounts
      ansible.builtin.debug:
        msg: "{{ service_accounts.stdout_lines }}"

    - name: Summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "  Namespaces Created Successfully!"
          - "=========================================="
          - ""
          - "Created Namespaces:"
          - "  - dev (development)"
          - "  - test (testing)"
          - "  - prod (production)"
          - ""
          - "RBAC Configured:"
          - "  - ServiceAccount: <namespace>-admin"
          - "  - Role: namespace-admin"
          - "  - RoleBinding: <namespace>-admin-binding"
          - ""
          - "Quick Commands:"
          - "  kubectl get all -n dev"
          - "  kubectl get all -n test"
          - "  kubectl get all -n prod"

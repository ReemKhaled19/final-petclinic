---
- name: Join Workers to Cluster
  hosts: workers
  become: true
  gather_facts: true
  serial: 1

  tasks:
    - name: Check if node is already joined
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/kubelet.conf get nodes 2>/dev/null | grep -q "{{ inventory_hostname }}" && echo "joined" || echo "not_joined"
      register: node_status
      changed_when: false
      failed_when: false

    - name: Display join status
      ansible.builtin.debug:
        msg: "Node {{ ansible_hostname }} is {{ 'already joined' if 'joined' in node_status.stdout else 'NOT joined' }}"

    - name: Skip if already joined
      ansible.builtin.meta: end_host
      when: "'joined' in node_status.stdout"

    - name: Create new bootstrap token
      ansible.builtin.shell: |
        kubeadm token create --ttl 30m
      register: new_token
      changed_when: false
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Get CA cert hash
      ansible.builtin.shell: |
        openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | \
        openssl rsa -pubin -outform der 2>/dev/null | \
        openssl dgst -sha256 -hex | sed 's/^.* //'
      register: ca_cert_hash
      changed_when: false
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Get control plane endpoint from kubeadm config
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf -n kube-system get configmap kubeadm-config -o jsonpath='{.data.ClusterConfiguration}' | grep controlPlaneEndpoint | awk '{print $2}'
      register: control_plane_endpoint
      changed_when: false
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Build worker join command with LB endpoint
      ansible.builtin.set_fact:
        worker_join_command: >-
          kubeadm join {{ control_plane_endpoint.stdout }}
          --token {{ new_token.stdout }}
          --discovery-token-ca-cert-hash sha256:{{ ca_cert_hash.stdout }}

    - name: Display join command
      ansible.builtin.debug:
        msg: "{{ worker_join_command }}"

    - name: Join worker to cluster
      ansible.builtin.shell: |
        {{ worker_join_command }}
      register: join_result
      async: 600
      poll: 10
      retries: 3
      delay: 10
      until: join_result.rc == 0
      changed_when: true

    - name: Wait for kubelet to start
      ansible.builtin.systemd:
        name: kubelet
        state: started
        enabled: true
      retries: 5
      delay: 10

    - name: Wait for node to be ready
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get node {{ ansible_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      register: node_ready
      until: node_ready.stdout == "True"
      retries: 30
      delay: 10
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Label worker node
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf label node {{ ansible_hostname }} node-role.kubernetes.io/worker='' --overwrite
      delegate_to: "{{ groups['first_master'][0] }}"
      changed_when: true

    - name: Verify worker joined successfully
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes {{ ansible_hostname }} -o wide
      register: verify_join
      changed_when: false
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Display verification
      ansible.builtin.debug:
        msg: "{{ verify_join.stdout_lines }}"

- name: Wait before next worker
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Pause between workers
      ansible.builtin.pause:
        seconds: 20

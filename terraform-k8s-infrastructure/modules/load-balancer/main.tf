# Network Load Balancer for Kubernetes API (Master nodes)
# ?????: ????? ??????? ??? ??? 3 masters ???? ??????
# ?????: Internal (???? ??? VPC ???? ?? exposed ????????)

resource "aws_lb" "master" {
  name               = "${var.project_name}-${var.environment}-master-nlb"
  internal           = true  # ??? ????: internal = true ???? ?? accessible ?? ????????
  load_balancer_type = "network"  # Network LB (Layer 4) ???? ?? Application LB
  subnets            = var.subnet_ids  # ????? ?? ??? 3 private subnets

  enable_deletion_protection       = false  # ??? dev/test, ?? ??? prod ???? true
  enable_cross_zone_load_balancing = true   # ???: ???? ???????? ??? ?? ??? AZs

  tags = {
    Name = "${var.project_name}-${var.environment}-master-nlb"
    Role = "KubernetesAPI"
  }
}

# Target Group: ???????? ???? ???? ??? masters
# ??? health check ????? ??? ??? masters ?? 10 ?????
resource "aws_lb_target_group" "master" {
  name     = "${var.project_name}-${var.environment}-master-tg"
  port     = 6443  # Kubernetes API Server port
  protocol = "TCP"
  vpc_id   = var.vpc_id

  # Health Check Configuration
  health_check {
    enabled             = true
    healthy_threshold   = 2    # ?? ??? 2 ???? ???????? ???? healthy
    unhealthy_threshold = 2    # ?? ??? 2 ???? ???????? ???? unhealthy
    interval            = 10   # ?? 10 ????? ???? check
    protocol            = "TCP"
    port                = "6443"  # ???? ??? ??? API port
    timeout             = 10   # ?? ????? ?? 10 ????? ?????? failed
  }

  # Stickiness: ?? ????????? ?? ??? K8s API
  stickiness {
    enabled = false
    type    = "source_ip"
  }

  # Deregistration delay: ??? ???? instance? ????? 30 ????? ??? ?? ???? ????????
  deregistration_delay = 30

  tags = {
    Name = "${var.project_name}-${var.environment}-master-tg"
  }
}

# Listener: ??? "???" ???? ????? ??????? ??????
# ?? ?? ???? ??? port 6443 ????? ??? target group
resource "aws_lb_listener" "master" {
  load_balancer_arn = aws_lb.master.arn
  port              = "6443"
  protocol          = "TCP"

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.master.arn
  }

  tags = {
    Name = "${var.project_name}-${var.environment}-master-listener"
  }
}


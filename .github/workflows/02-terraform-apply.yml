name: 02 - Terraform Apply & Ansible Provision

on:
  push:
    branches:
      - main
    paths:
      - 'terraform-k8s-infrastructure/**'
  workflow_dispatch:

env:
  TF_VERSION: "1.6.0"
  AWS_REGION: "us-east-1"

jobs:
  terraform-apply:
    name: Deploy AWS Infrastructure
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write
      actions: write

    outputs:
      bastion_ip: ${{ steps.extract.outputs.bastion_ip }}
      lb_dns: ${{ steps.extract.outputs.lb_dns }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ§ª Test AWS Connection
        run: aws sts get-caller-identity

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: âš™ï¸ Terraform Init
        working-directory: terraform-k8s-infrastructure
        run: terraform init

      - name: âœ… Terraform Validate
        working-directory: terraform-k8s-infrastructure
        run: terraform validate

      - name: ğŸš€ Terraform Apply
        working-directory: terraform-k8s-infrastructure
        run: terraform apply -auto-approve -input=false

      - name: ğŸ“Š Extract Outputs
        id: extract
        working-directory: terraform-k8s-infrastructure
        run: |
          BASTION_IP=$(terraform output -raw bastion_public_ip)
          LB_DNS=$(terraform output -raw master_load_balancer_dns)
          
          echo "bastion_ip=${BASTION_IP}" >> "$GITHUB_OUTPUT"
          echo "lb_dns=${LB_DNS}" >> "$GITHUB_OUTPUT"
          
          echo "âœ… Bastion IP: ${BASTION_IP}"
          echo "âœ… LB DNS: ${LB_DNS}"

      - name: ğŸ“¦ Save Outputs
        working-directory: terraform-k8s-infrastructure
        run: |
          mkdir -p /tmp/terraform-outputs
          
          terraform output -raw bastion_public_ip > /tmp/terraform-outputs/bastion_ip.txt
          terraform output -raw master_load_balancer_dns > /tmp/terraform-outputs/lb_dns.txt
          terraform output -json master_private_ips > /tmp/terraform-outputs/master_ips.json
          terraform output -json worker_private_ips > /tmp/terraform-outputs/worker_ips.json
          terraform output -raw ssh_private_key > /tmp/terraform-outputs/petclinic-test-key.pem
          chmod 400 /tmp/terraform-outputs/petclinic-test-key.pem

      - name: ğŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp/terraform-outputs
          retention-days: 7

      - name: â³ Wait for EC2 Boot (8 minutes)
        run: |
          echo "â³ Waiting 8 minutes for:"
          echo "  â€¢ EC2 instances to boot"
          echo "  â€¢ User-data scripts to complete"
          echo "  â€¢ Kubernetes components to install"
          sleep 480

  ansible-provision:
    name: Configure Kubernetes Cluster
    runs-on: ubuntu-latest
    needs: terraform-apply

    env:
      ANSIBLE_HOST_KEY_CHECKING: "False"

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Ansible
        run: |
          pip install --upgrade pip
          pip install ansible
          ansible --version

      - name: ğŸ” Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“¥ Download Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp/terraform-outputs

      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          cp /tmp/terraform-outputs/petclinic-test-key.pem ~/.ssh/
          chmod 400 ~/.ssh/petclinic-test-key.pem
          
          cat >> ~/.ssh/config <<EOF
          Host *
              StrictHostKeyChecking no
              UserKnownHostsFile=/dev/null
          EOF
          chmod 600 ~/.ssh/config

      - name: ğŸ“ Generate Inventory
        working-directory: ansible-k8s-setup
        run: |
          BASTION_IP=$(cat /tmp/terraform-outputs/bastion_ip.txt)
          LB_DNS=$(cat /tmp/terraform-outputs/lb_dns.txt)
          MASTER_IPS=$(jq -r '.[]' /tmp/terraform-outputs/master_ips.json)
          WORKER_IPS=$(jq -r '.[]' /tmp/terraform-outputs/worker_ips.json)
          
          cat > inventory/hosts.ini <<EOF
          # Kubernetes Cluster Inventory
          # Generated: $(date -u)
          
          [bastion_host]
          bastion-1 ansible_host=${BASTION_IP} ansible_user=ubuntu
          
          [masters]
          EOF
          
          i=1
          for ip in $MASTER_IPS; do
            echo "master-${i} ansible_host=${ip} node_type=master node_index=${i}" >> inventory/hosts.ini
            i=$((i+1))
          done
          
          cat >> inventory/hosts.ini <<EOF
          
          [workers]
          EOF
          
          i=1
          for ip in $WORKER_IPS; do
            echo "worker-${i} ansible_host=${ip} node_type=worker node_index=${i}" >> inventory/hosts.ini
            i=$((i+1))
          done
          
          cat >> inventory/hosts.ini <<'EOF'
          
          [first_master]
          master-1
          
          [other_masters]
          master-2
          master-3
          
          [k8s_cluster:children]
          masters
          workers
          
          [all:children]
          bastion_host
          k8s_cluster
          
          [k8s_cluster:vars]
          ansible_user=ubuntu
          ansible_python_interpreter=/usr/bin/python3
          ansible_ssh_private_key_file=~/.ssh/petclinic-test-key.pem
          EOF
          
          echo "ansible_ssh_common_args='-o ProxyCommand=\"ssh -W %h:%p -i ~/.ssh/petclinic-test-key.pem -o StrictHostKeyChecking=no ubuntu@${BASTION_IP}\"'" >> inventory/hosts.ini
          
          cat >> inventory/hosts.ini <<'EOF'
          
          [masters:vars]
          k8s_role=master
          
          [workers:vars]
          k8s_role=worker
          
          [bastion_host:vars]
          ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF
          
          sed -i "s|control_plane_endpoint:.*|control_plane_endpoint: \"${LB_DNS}:6443\"|" inventory/group_vars/all.yml

      - name: ğŸ‘ï¸ Show Inventory
        working-directory: ansible-k8s-setup
        run: cat inventory/hosts.ini

      - name: â³ Smart Wait for User-Data
        working-directory: ansible-k8s-setup
        run: |
          echo "â³ Waiting for all nodes to complete user-data..."

          MAX_ATTEMPTS=5
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo "Check $((ATTEMPT+1))/$MAX_ATTEMPTS..."
            
            ALL_READY=true
            for host in master-1 master-2 master-3 worker-1 worker-2 worker-3; do
              if ansible $host -i inventory/hosts.ini -m shell \
                -a "test -f /tmp/node-ready" &>/dev/null; then
                echo "  âœ… $host ready"
              else
                echo "  â³ $host not ready yet"
                ALL_READY=false
              fi
            done
            
            if [ "$ALL_READY" = true ]; then
              echo ""
              echo "âœ… All nodes ready!"
              break
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "  Waiting 30 seconds..."
              sleep 30
            fi
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "âš ï¸ Timeout - but proceeding anyway"
          fi

      - name: "ğŸ¯ Step 2/9: Init First Master"
        working-directory: ansible-k8s-setup
        run: ansible-playbook -i inventory/hosts.ini playbooks/02-init-first-master.yml

      - name: "ğŸ”— Step 3/9: Join Masters"
        working-directory: ansible-k8s-setup
        run: ansible-playbook -i inventory/hosts.ini playbooks/03-join-masters.yml

      - name: "ğŸ‘· Step 4/9: Join Workers"
        working-directory: ansible-k8s-setup
        run: ansible-playbook -i inventory/hosts.ini playbooks/04-join-workers.yml

      - name: "ğŸŒ Step 5/9: Install CNI"
        working-directory: ansible-k8s-setup
        run: ansible-playbook -i inventory/hosts.ini playbooks/05-install-cni.yml

      - name: "ğŸ“¦ Step 6/9: Create Namespaces"
        working-directory: ansible-k8s-setup
        run: ansible-playbook -i inventory/hosts.ini playbooks/06-create-namespaces.yml

      - name: "ğŸ–¥ï¸ Step 7/9: Setup Kubectl"
        working-directory: ansible-k8s-setup
        run: ansible-playbook -i inventory/hosts.ini playbooks/07-setup-kubectl-bastion.yml

      - name: "ğŸ”€ Step 8/9: Install Ingress"
        working-directory: ansible-k8s-setup
        run: ansible-playbook -i inventory/hosts.ini playbooks/08-install-ingress-nginx.yml

      - name: "ğŸ”§ Step 9/9: Final Cluster Fixes"
        working-directory: ansible-k8s-setup
        run: ansible-playbook -i inventory/hosts.ini playbooks/99-final-fixes.yml

      - name: ğŸ“¥ Fetch Kubeconfig
        run: |
          BASTION_IP=$(cat /tmp/terraform-outputs/bastion_ip.txt)
          scp -i ~/.ssh/petclinic-test-key.pem -o StrictHostKeyChecking=no \
            ubuntu@${BASTION_IP}:~/.kube/config /tmp/kubeconfig || true

      - name: ğŸ“¦ Upload Kubeconfig
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig
          path: /tmp/kubeconfig
          retention-days: 7

      - name: ğŸ‰ Summary
        run: |
          BASTION_IP=$(cat /tmp/terraform-outputs/bastion_ip.txt)
          LB_DNS=$(cat /tmp/terraform-outputs/lb_dns.txt)
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ‰ Cluster Setup Complete!          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â€¢ Bastion:  ${BASTION_IP}"
          echo "â€¢ API:      ${LB_DNS}:6443"
          echo "â€¢ Masters:  3"
          echo "â€¢ Workers:  3"
